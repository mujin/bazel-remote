#!/usr/bin/env bash
set -euo pipefail

# Defaults
REGISTRY="${REGISTRY:-docker.io}"
IMAGE_NAME="${IMAGE_NAME:-buchgr/bazel-remote-cache}"
TAG="${TAG:-latest}"

FULL_IMAGE="${REGISTRY}/${IMAGE_NAME}"

script_dir=$(cd -- "$(dirname -- "${BASH_SOURCE[0]}")" && pwd)
cd "$script_dir/.."

# Detect arch.
img_arch=amd64
if [[ "$(uname -m)" == "arm64" || "$(uname -m)" == "aarch64" ]]; then
    img_arch=arm64
fi

echo "Building and pushing $img_arch image..."

# Build and load.
bazel run //:bazel-remote-image-${img_arch}-tarball

# Tag and push.
docker tag bazel-remote-cache:tmp-${img_arch} "$FULL_IMAGE:tmp-${img_arch}"
docker push "$FULL_IMAGE:tmp-${img_arch}"

# Collect existing arch images.
manifest_args=()

for arch in amd64 arm64; do
    if docker manifest inspect "$FULL_IMAGE:tmp-${arch}" >/dev/null 2>&1; then
        manifest_args+=( "$FULL_IMAGE:tmp-${arch}" )
    fi
done

if [[ ${#manifest_args[@]} -eq 0 ]]; then
    echo "ERROR: no images found to create manifest"
    exit 1
fi

# Recreate manifest atomically
docker manifest rm "$FULL_IMAGE:$TAG" >/dev/null 2>&1 || true

docker manifest create "$FULL_IMAGE:$TAG" "${manifest_args[@]}"
docker manifest push "$FULL_IMAGE:$TAG"

echo "Updated multi-arch manifest: $FULL_IMAGE:$TAG"